trigger:
  branches:
    include:
      - master  # âœ… Ejecutar solo en la rama 'master'

pool:
  vmImage: 'ubuntu-latest'

variables:
  PROJECT_NAME: 'uptimestars'

steps:

- script: |
    echo "âœ… Ejecutando en rama: $(Build.SourceBranch)"
  displayName: 'Mostrar rama actual'

- script: |
    echo "ğŸ” Verificando entorno y docker-compose.yml"
    docker --version
    find . -name "docker-compose.yml"
  displayName: 'DiagnÃ³stico inicial'

- task: DockerCompose@1
  displayName: 'ğŸš€ Build & Run Docker Compose'
  inputs:
    containerregistrytype: 'Container Registry'
    dockerComposeFile: 'Uptime.Stars.Backend/docker-compose.yml'  # âœ… Ruta correcta
    action: 'Run services'
    projectName: '$(PROJECT_NAME)'
    buildImages: true

- script: |
    echo "â³ Esperando arranque de servicios..."
    sleep 20
  displayName: 'Delay para servicios'

- script: |
    echo "ğŸŒ Verificando acceso a la API en http://localhost:8080"
    curl -sf http://localhost:8080 || (echo "âŒ API no responde" && exit 1)
  displayName: 'Verificar API levantada'
