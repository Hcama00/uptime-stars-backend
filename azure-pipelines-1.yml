trigger:
  branches:
    include:
      - master  # o la rama principal que uses

pool:
  vmImage: 'ubuntu-latest'

variables:
  PROJECT_NAME: 'uptime‑stars'  # útil evitar caracteres inválidos

steps:

- task: DockerInstaller@0
  inputs:
    dockerVersion: 'latest'

- task: DockerCompose@1   # usa versión 1 para compatibilidad con v2
  displayName: 'Build & run Docker Compose'
  inputs:
    containerregistrytype: 'Container Registry'
    dockerComposeFile: '**/docker-compose.yml'
    action: 'Run services'
    projectName: '$(PROJECT_NAME)'
    buildImages: true

- script: |
    echo "Esperando que los servicios levanten..."
    sleep 20
  displayName: 'Delay startup'

- script: |
    curl -sf http://localhost:8080/health || (echo "API no responde" && exit 1)
  displayName: 'Check uptime.stars.api'
